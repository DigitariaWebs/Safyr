import {
  PayrollControl,
  ControlExecution,
  PayrollAnomaly,
} from "@/lib/types";

// Available control definitions
export const PAYROLL_CONTROLS: PayrollControl[] = [
  {
    id: "ctrl_hours_planning",
    name: "Cohérence Heures vs Planning",
    category: "hours",
    description: "Vérifier que les heures déclarées correspondent au planning",
    enabled: true,
    severity: "warning",
  },
  {
    id: "ctrl_duplicates",
    name: "Détection des Doublons",
    category: "duplicates",
    description: "Détecter les saisies en double pour un même employé",
    enabled: true,
    severity: "critical",
  },
  {
    id: "ctrl_missing_entries",
    name: "Détection des Oublis",
    category: "duplicates",
    description: "Détecter les employés sans saisie pour la période",
    enabled: true,
    severity: "warning",
  },
  {
    id: "ctrl_daily_max",
    name: "Amplitude Journalière Maximum",
    category: "legal",
    description: "Contrôler que la durée quotidienne ne dépasse pas 10h (ou 12h avec dérogation)",
    enabled: true,
    severity: "critical",
  },
  {
    id: "ctrl_weekly_max",
    name: "Durée Hebdomadaire Maximum",
    category: "legal",
    description: "Contrôler que la durée hebdomadaire ne dépasse pas 48h",
    enabled: true,
    severity: "critical",
  },
  {
    id: "ctrl_rest_period",
    name: "Temps de Repos Minimum",
    category: "legal",
    description: "Vérifier le respect des 11h de repos quotidien et 35h hebdomadaire",
    enabled: true,
    severity: "critical",
  },
  {
    id: "ctrl_night_bonus",
    name: "Primes de Nuit",
    category: "bonuses",
    description: "Vérifier la cohérence entre heures de nuit et primes de nuit",
    enabled: true,
    severity: "warning",
  },
  {
    id: "ctrl_holiday_bonus",
    name: "Primes Jours Fériés",
    category: "bonuses",
    description: "Vérifier la cohérence entre travail férié et primes fériées",
    enabled: true,
    severity: "warning",
  },
  {
    id: "ctrl_oncall_bonus",
    name: "Indemnités d'Astreinte",
    category: "bonuses",
    description: "Vérifier la cohérence entre astreintes planifiées et indemnités",
    enabled: true,
    severity: "warning",
  },
  {
    id: "ctrl_ijss_amount",
    name: "Montants IJSS",
    category: "ijss",
    description: "Contrôler la cohérence des montants d'indemnités journalières",
    enabled: true,
    severity: "warning",
  },
  {
    id: "ctrl_ijss_missing",
    name: "IJSS Manquantes",
    category: "ijss",
    description: "Détecter les arrêts maladie sans IJSS déclarées",
    enabled: true,
    severity: "info",
  },
  {
    id: "ctrl_overtime_limit",
    name: "Limites Heures Supplémentaires",
    category: "legal",
    description: "Contrôler le respect des contingents d'heures supplémentaires",
    enabled: true,
    severity: "critical",
  },
];

// Mock anomalies
export const MOCK_ANOMALIES: PayrollAnomaly[] = [
  {
    id: "anom_001",
    executionId: "exec_001",
    controlId: "ctrl_hours_planning",
    employeeId: "emp_001",
    employeeName: "Dubois Jean",
    type: "hours_vs_planning",
    title: "Heures déclarées sans planning",
    description: "7.5h déclarées le 15/12 mais aucune vacation planifiée",
    severity: "warning",
    period: "2024-12",
    date: new Date("2024-12-15"),
    status: "pending",
    details: {
      actual: { normalHours: 7.5, date: "2024-12-15" },
      expected: { normalHours: 0, date: "2024-12-15" },
      related: { shift: null },
    },
    autoCorrectAvailable: false,
    createdAt: new Date("2024-12-20T10:00:00"),
    updatedAt: new Date("2024-12-20T10:00:00"),
  },
  {
    id: "anom_002",
    executionId: "exec_001",
    controlId: "ctrl_hours_planning",
    employeeId: "emp_005",
    employeeName: "Laurent Sophie",
    type: "hours_vs_planning",
    title: "Planning sans heures déclarées",
    description: "Vacation de 8h planifiée le 18/12 mais aucune heure saisie",
    severity: "warning",
    period: "2024-12",
    date: new Date("2024-12-18"),
    status: "pending",
    details: {
      actual: { normalHours: 0, date: "2024-12-18" },
      expected: { normalHours: 8, date: "2024-12-18" },
      planningData: { shiftStart: "08:00", shiftEnd: "16:00", site: "Site A" },
    },
    autoCorrectAvailable: true,
    correction: {
      action: "import_from_planning",
      description: "Importer automatiquement 8h depuis le planning",
      payload: { normalHours: 8, date: "2024-12-18" },
    },
    createdAt: new Date("2024-12-20T10:00:00"),
    updatedAt: new Date("2024-12-20T10:00:00"),
  },
  {
    id: "anom_003",
    executionId: "exec_001",
    controlId: "ctrl_hours_planning",
    employeeId: "emp_012",
    employeeName: "Moreau Thomas",
    type: "hours_vs_planning",
    title: "Écart significatif heures vs planning",
    description: "10h déclarées le 20/12 mais seulement 7.5h planifiées",
    severity: "warning",
    period: "2024-12",
    date: new Date("2024-12-20"),
    status: "pending",
    details: {
      actual: { normalHours: 10, date: "2024-12-20" },
      expected: { normalHours: 7.5, date: "2024-12-20" },
      planningData: { shiftStart: "09:00", shiftEnd: "16:30", site: "Site C" },
    },
    autoCorrectAvailable: false,
    createdAt: new Date("2024-12-20T10:00:00"),
    updatedAt: new Date("2024-12-20T10:00:00"),
  },
  {
    id: "anom_004",
    executionId: "exec_001",
    controlId: "ctrl_daily_max",
    employeeId: "emp_008",
    employeeName: "Petit Marie",
    type: "excessive_hours",
    title: "Durée quotidienne excessive",
    description: "11h travaillées le 19/12 (maximum légal: 10h)",
    severity: "critical",
    period: "2024-12",
    date: new Date("2024-12-19"),
    expectedValue: 10,
    actualValue: 11,
    status: "pending",
    details: {
      actual: { totalHours: 11, normalHours: 9, overtimeHours25: 2 },
      expected: { maxDailyHours: 10 },
      related: { hasDerogation: false },
    },
    autoCorrectAvailable: false,
    createdAt: new Date("2024-12-20T10:00:00"),
    updatedAt: new Date("2024-12-20T10:00:00"),
  },
  {
    id: "anom_005",
    executionId: "exec_001",
    controlId: "ctrl_rest_period",
    employeeId: "emp_003",
    employeeName: "Martin Claire",
    type: "insufficient_rest",
    title: "Repos quotidien insuffisant",
    description: "Seulement 9h de repos entre deux vacations (minimum légal: 11h)",
    severity: "critical",
    period: "2024-12",
    date: new Date("2024-12-16"),
    expectedValue: 11,
    actualValue: 9,
    status: "pending",
    details: {
      actual: { restHours: 9, endTime: "23:00", nextStartTime: "08:00" },
      expected: { minRestHours: 11 },
      related: {
        shift1: { date: "2024-12-15", end: "23:00" },
        shift2: { date: "2024-12-16", start: "08:00" },
      },
    },
    autoCorrectAvailable: false,
    createdAt: new Date("2024-12-20T10:00:00"),
    updatedAt: new Date("2024-12-20T10:00:00"),
  },
  {
    id: "anom_006",
    executionId: "exec_001",
    controlId: "ctrl_rest_period",
    employeeId: "emp_015",
    employeeName: "Bernard Lucas",
    type: "insufficient_rest",
    title: "Repos quotidien insuffisant",
    description: "Seulement 10h de repos entre deux vacations (minimum légal: 11h)",
    severity: "critical",
    period: "2024-12",
    date: new Date("2024-12-17"),
    expectedValue: 11,
    actualValue: 10,
    status: "pending",
    details: {
      actual: { restHours: 10, endTime: "22:00", nextStartTime: "08:00" },
      expected: { minRestHours: 11 },
      related: {
        shift1: { date: "2024-12-16", end: "22:00" },
        shift2: { date: "2024-12-17", start: "08:00" },
      },
    },
    autoCorrectAvailable: false,
    createdAt: new Date("2024-12-20T10:00:00"),
    updatedAt: new Date("2024-12-20T10:00:00"),
  },
  {
    id: "anom_007",
    executionId: "exec_001",
    controlId: "ctrl_night_bonus",
    employeeId: "emp_009",
    employeeName: "Roux Emma",
    type: "bonus_inconsistency",
    title: "Prime de nuit sans heures de nuit",
    description: "Prime de nuit déclarée (25€) mais 0h de nuit travaillées",
    severity: "warning",
    period: "2024-12",
    date: new Date("2024-12-21"),
    expectedValue: 0,
    actualValue: 25,
    currency: "EUR",
    status: "pending",
    details: {
      actual: { nightBonus: 25, nightHours: 0 },
      expected: { nightBonus: 0, nightHours: 0 },
    },
    autoCorrectAvailable: true,
    correction: {
      action: "remove_bonus",
      description: "Supprimer la prime de nuit incorrecte",
      payload: { removeBonus: "night", amount: 25 },
    },
    createdAt: new Date("2024-12-20T10:00:00"),
    updatedAt: new Date("2024-12-20T10:00:00"),
  },
  {
    id: "anom_008",
    executionId: "exec_001",
    controlId: "ctrl_holiday_bonus",
    employeeId: "emp_011",
    employeeName: "Fournier Paul",
    type: "bonus_inconsistency",
    title: "Prime férié sur jour non férié",
    description: "Prime jour férié déclarée (50€) le 17/12 qui n'est pas un jour férié",
    severity: "warning",
    period: "2024-12",
    date: new Date("2024-12-17"),
    expectedValue: 0,
    actualValue: 50,
    currency: "EUR",
    status: "pending",
    details: {
      actual: { holidayBonus: 50, date: "2024-12-17" },
      expected: { holidayBonus: 0, date: "2024-12-17" },
      related: { isPublicHoliday: false },
    },
    autoCorrectAvailable: true,
    correction: {
      action: "remove_bonus",
      description: "Supprimer la prime jour férié incorrecte",
      payload: { removeBonus: "holiday", amount: 50 },
    },
    createdAt: new Date("2024-12-20T10:00:00"),
    updatedAt: new Date("2024-12-20T10:00:00"),
  },
  {
    id: "anom_009",
    executionId: "exec_001",
    controlId: "ctrl_duplicates",
    employeeId: "emp_006",
    employeeName: "Dupont Julie",
    type: "duplicate_entry",
    title: "Saisie en double",
    description: "Deux saisies trouvées pour la même date (14/12)",
    severity: "critical",
    period: "2024-12",
    date: new Date("2024-12-14"),
    status: "pending",
    details: {
      actual: { entries: 2, totalHours: 15 },
      expected: { entries: 1 },
      related: {
        entry1: { id: "var_001", hours: 7.5, source: "manual" },
        entry2: { id: "var_002", hours: 7.5, source: "planning" },
      },
    },
    autoCorrectAvailable: true,
    correction: {
      action: "merge_entries",
      description: "Fusionner les deux saisies en une seule",
      payload: { keepEntry: "var_002", deleteEntry: "var_001" },
    },
    createdAt: new Date("2024-12-20T10:00:00"),
    updatedAt: new Date("2024-12-20T10:00:00"),
  },
  {
    id: "anom_010",
    executionId: "exec_001",
    controlId: "ctrl_ijss_amount",
    employeeId: "emp_007",
    employeeName: "Simon Antoine",
    type: "ijss_mismatch",
    title: "Montant IJSS incohérent",
    description: "IJSS déclarées: 485€ pour 10 jours, attendu: ~500€",
    severity: "warning",
    period: "2024-12",
    date: new Date("2024-12-10"),
    expectedValue: 500,
    actualValue: 485,
    currency: "EUR",
    status: "pending",
    details: {
      actual: { ijssAmount: 485, days: 10 },
      expected: { ijssAmount: 500, dailyRate: 50 },
      related: { dailySalary: 100, ijssRate: 0.5 },
    },
    autoCorrectAvailable: true,
    correction: {
      action: "adjust_ijss",
      description: "Ajuster le montant IJSS à 500€",
      payload: { newAmount: 500 },
    },
    createdAt: new Date("2024-12-20T10:00:00"),
    updatedAt: new Date("2024-12-20T10:00:00"),
  },
  {
    id: "anom_011",
    executionId: "exec_001",
    controlId: "ctrl_ijss_amount",
    employeeId: "emp_014",
    employeeName: "Robert Nina",
    type: "ijss_mismatch",
    title: "Montant IJSS incohérent",
    description: "IJSS déclarées: 220€ pour 5 jours, attendu: ~250€",
    severity: "warning",
    period: "2024-12",
    date: new Date("2024-12-05"),
    expectedValue: 250,
    actualValue: 220,
    currency: "EUR",
    status: "pending",
    details: {
      actual: { ijssAmount: 220, days: 5 },
      expected: { ijssAmount: 250, dailyRate: 50 },
      related: { dailySalary: 100, ijssRate: 0.5 },
    },
    autoCorrectAvailable: true,
    correction: {
      action: "adjust_ijss",
      description: "Ajuster le montant IJSS à 250€",
      payload: { newAmount: 250 },
    },
    createdAt: new Date("2024-12-20T10:00:00"),
    updatedAt: new Date("2024-12-20T10:00:00"),
  },
  {
    id: "anom_012",
    executionId: "exec_001",
    controlId: "ctrl_ijss_missing",
    employeeId: "emp_010",
    employeeName: "Blanc Marc",
    type: "ijss_missing",
    title: "IJSS manquantes",
    description: "Arrêt maladie de 3 jours (12-14/12) sans IJSS déclarées",
    severity: "info",
    period: "2024-12",
    date: new Date("2024-12-12"),
    status: "pending",
    details: {
      actual: { ijssAmount: 0, sickLeaveDays: 3 },
      expected: { ijssAmount: 150, estimatedDailyRate: 50 },
      related: { sickLeaveStart: "2024-12-12", sickLeaveEnd: "2024-12-14" },
    },
    autoCorrectAvailable: false,
    createdAt: new Date("2024-12-20T10:00:00"),
    updatedAt: new Date("2024-12-20T10:00:00"),
  },
  {
    id: "anom_013",
    executionId: "exec_001",
    controlId: "ctrl_overtime_limit",
    employeeId: "emp_004",
    employeeName: "Garcia Luis",
    type: "overtime_limit",
    title: "Dépassement heures supplémentaires",
    description: "52h travaillées sur la semaine 50 (maximum légal: 48h)",
    severity: "critical",
    period: "2024-12",
    date: new Date("2024-12-16"),
    expectedValue: 48,
    actualValue: 52,
    status: "pending",
    details: {
      actual: { weeklyHours: 52, week: 50, overtimeHours: 17 },
      expected: { maxWeeklyHours: 48 },
      related: {
        breakdown: [
          { date: "2024-12-16", hours: 10 },
          { date: "2024-12-17", hours: 10 },
          { date: "2024-12-18", hours: 11 },
          { date: "2024-12-19", hours: 10 },
          { date: "2024-12-20", hours: 11 },
        ],
      },
    },
    autoCorrectAvailable: false,
    createdAt: new Date("2024-12-20T10:00:00"),
    updatedAt: new Date("2024-12-20T10:00:00"),
  },
  {
    id: "anom_014",
    executionId: "exec_001",
    controlId: "ctrl_missing_entries",
    employeeId: "emp_013",
    employeeName: "Leroy Sarah",
    type: "missing_entry",
    title: "Aucune saisie pour la période",
    description: "Employée active mais aucune variable saisie pour décembre 2024",
    severity: "warning",
    period: "2024-12",
    status: "pending",
    details: {
      actual: { entriesCount: 0 },
      expected: { entriesCount: ">0" },
      related: { contractStatus: "active", hasPlanning: true },
    },
    autoCorrectAvailable: false,
    createdAt: new Date("2024-12-20T10:00:00"),
    updatedAt: new Date("2024-12-20T10:00:00"),
  },
];

// Mock execution history
export const MOCK_EXECUTIONS: ControlExecution[] = [
  {
    id: "exec_001",
    periodId: "period_2024_12",
    period: "Décembre 2024",
    startedAt: new Date("2024-12-20T10:00:00"),
    completedAt: new Date("2024-12-20T10:05:23"),
    status: "completed",
    controlsRun: PAYROLL_CONTROLS.map((c) => c.id),
    totalAnomalies: 14,
    criticalCount: 5,
    warningCount: 7,
    infoCount: 2,
    employeesAffected: 13,
    autoCorrectableCount: 6,
  },
  {
    id: "exec_002",
    periodId: "period_2024_11",
    period: "Novembre 2024",
    startedAt: new Date("2024-11-20T14:30:00"),
    completedAt: new Date("2024-11-20T14:34:12"),
    status: "completed",
    controlsRun: PAYROLL_CONTROLS.map((c) => c.id),
    totalAnomalies: 8,
    criticalCount: 2,
    warningCount: 5,
    infoCount: 1,
    employeesAffected: 8,
    autoCorrectableCount: 3,
  },
  {
    id: "exec_003",
    periodId: "period_2024_10",
    period: "Octobre 2024",
    startedAt: new Date("2024-10-20T09:15:00"),
    completedAt: new Date("2024-10-20T09:19:45"),
    status: "completed",
    controlsRun: PAYROLL_CONTROLS.map((c) => c.id),
    totalAnomalies: 11,
    criticalCount: 3,
    warningCount: 6,
    infoCount: 2,
    employeesAffected: 10,
    autoCorrectableCount: 4,
  },
];

// Helper functions
export function getControlsByCategory(
  category: PayrollControl["category"]
): PayrollControl[] {
  return PAYROLL_CONTROLS.filter((control) => control.category === category);
}

export function getAnomaliesBySeverity(
  severity: PayrollAnomaly["severity"]
): PayrollAnomaly[] {
  return MOCK_ANOMALIES.filter((anomaly) => anomaly.severity === severity);
}

export function getAnomaliesByEmployee(employeeId: string): PayrollAnomaly[] {
  return MOCK_ANOMALIES.filter((anomaly) => anomaly.employeeId === employeeId);
}

export function getAnomaliesByStatus(
  status: PayrollAnomaly["status"]
): PayrollAnomaly[] {
  return MOCK_ANOMALIES.filter((anomaly) => anomaly.status === status);
}

export function getAutoCorrectableAnomalies(): PayrollAnomaly[] {
  return MOCK_ANOMALIES.filter((anomaly) => anomaly.autoCorrectAvailable);
}

export function getCategoryCounts() {
  const counts: Record<string, number> = {};
  PAYROLL_CONTROLS.forEach((control) => {
    const anomalies = MOCK_ANOMALIES.filter(
      (a) => a.controlId === control.id
    ).length;
    if (!counts[control.category]) {
      counts[control.category] = 0;
    }
    counts[control.category] += anomalies;
  });
  return counts;
}
